Directory structure:
└── rx4/
    ├── boot.nix
    ├── default.nix
    ├── disks.sh
    ├── gnome.nix
    ├── hardware.nix
    ├── packages.nix
    └── secrets/
        ├── default.nix
        └── secrets.yaml

================================================
FILE: boot.nix
================================================
{
  boot.loader.systemd-boot = {
    enable = true;
    configurationLimit = 20;
  };
  boot.loader.efi.canTouchEfiVariables = true;
}



================================================
FILE: default.nix
================================================
{
  inputs,
  outputs,
  ...
}:

{
  imports = [
    ./boot.nix
    ./gnome.nix
    ./hardware.nix
    ./packages.nix
    ./secrets

    ../../users/sid

    inputs.core.nixosModules.common
    inputs.core.nixosModules.openssh

    outputs.nixosModules.common
    outputs.nixosModules.tailscale
  ];

  networking.hostName = "rx4";
  networking.domain = "rx4.lan";

  services = {
    openssh.enable = true;
    transmission.enable = true;
  };

  system.stateVersion = "25.11";
}



================================================
FILE: disks.sh
================================================
#!/usr/bin/env bash

SSD='/dev/disk/by-id/nvme-KINGSTON_SNV3SM3500G_50026B7283B1AFB4_1'
MNT='/mnt'
SWAP_GB=8

# Helper function to wait for devices
wait_for_device() {
  local device=$1
  echo "Waiting for device: $device ..."
  while [[ ! -e $device ]]; do
    sleep 1
  done
  echo "Device $device is ready."
}

# Function to install a package if it's not already installed
install_if_missing() {
  local cmd="$1"
  local package="$2"
  if ! command -v "$cmd" &> /dev/null; then
    echo "$cmd not found, installing $package..."
    nix-env -iA "nixos.$package"
  fi
}

install_if_missing "sgdisk" "gptfdisk"
install_if_missing "partprobe" "parted"

wait_for_device $SSD

echo "Wiping filesystem on $SSD..."
wipefs -a $SSD

echo "Clearing partition table on $SSD..."
sgdisk --zap-all $SSD

echo "Partitioning $SSD..."
sgdisk -n1:1M:+1G         -t1:EF00 -c1:BOOT $SSD
sgdisk -n2:0:+"$SWAP_GB"G -t2:8200 -c2:SWAP $SSD
sgdisk -n3:0:0            -t3:8304 -c3:ROOT $SSD
partprobe -s $SSD
udevadm settle

wait_for_device ${SSD}-part1
wait_for_device ${SSD}-part2
wait_for_device ${SSD}-part3

echo "Formatting partitions..."
mkfs.vfat -F 32 -n BOOT "${SSD}-part1"
mkswap -L SWAP "${SSD}-part2"
mkfs.ext4 -L ROOT "${SSD}-part3"

echo "Mounting partitions..."
mount -o X-mount.mkdir "${SSD}-part3" "$MNT"
mkdir -p "$MNT/boot"
mount -t vfat -o fmask=0077,dmask=0077,iocharset=iso8859-1 "${SSD}-part1" "$MNT/boot"

echo "Enabling swap..."
swapon "${SSD}-part2"

echo "Partitioning and setup complete:"
lsblk -o NAME,FSTYPE,SIZE,MOUNTPOINT,LABEL



================================================
FILE: gnome.nix
================================================
{ pkgs, ... }:

{
  services.displayManager.gdm.enable = true;
  services.desktopManager.gnome.enable = true;

  services.gnome.core-apps.enable = false;
  services.gnome.core-developer-tools.enable = false;
  services.gnome.games.enable = false;
  services.gnome.gnome-remote-desktop.enable = true;
  environment.gnome.excludePackages = with pkgs; [
    gnome-tour
    gnome-user-docs
  ];

  # https://github.com/NixOS/nixpkgs/issues/266774#issuecomment-2525412206
  systemd.services."gnome-remote-desktop".wantedBy = [ "graphical.target" ];
  networking.firewall = {
    allowedTCPPorts = [ 3389 ];
    allowedUDPPorts = [ 3389 ];
  };

  programs.firefox.enable = true;

  environment.systemPackages = with pkgs; [
    networkmanagerapplet
  ];
}



================================================
FILE: hardware.nix
================================================
{
  config,
  lib,
  pkgs,
  modulesPath,
  ...
}:

{
  imports = [
    (modulesPath + "/installer/scan/not-detected.nix")
  ];

  boot.initrd.availableKernelModules = [
    "nvme"
    "sd_mod"
    "sdhci_pci"
    "usb_storage"
    "usbhid"
    "xhci_pci"
  ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" = {
    device = "/dev/disk/by-label/ROOT";
    fsType = "ext4";
  };

  fileSystems."/boot" = {
    device = "/dev/disk/by-label/BOOT";
    fsType = "vfat";
    options = [
      "fmask=0022"
      "dmask=0022"
    ];
  };

  swapDevices = [
    { device = "/dev/disk/by-label/SWAP"; }
  ];

  networking.useDHCP = lib.mkDefault true;

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.amd.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}



================================================
FILE: packages.nix
================================================
{ pkgs, ... }:

{
  environment.systemPackages = with pkgs; [ ];
}



================================================
FILE: secrets/default.nix
================================================
{ inputs, ... }:

{
  imports = [ inputs.core.nixosModules.sops ];
}



================================================
FILE: secrets/secrets.yaml
================================================
tailscale:
    auth-key: ENC[AES256_GCM,data:EXkT4wfQyEoLOGSia0cLcnnabQu8wzO6FgjGC1hEFDZI3XDCX31EUZvSZiU6KvbG,iv:yVLCbIDwg04QAE9lx8KQjAEiBy0EN8VDAytAAFUZUHk=,tag:Rswv3CJCjL59zxzoX0IQTQ==,type:str]
sops:
    age:
        - recipient: age19yeqvv28fgrtk6jsh3xyaf0lch86kna6rcz4dwe962yyyyevu30sx474xy
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBZT2hXL0NoNUVWWmc3Tngv
            Y3NUaVhUUU9ZVHBxc1d0WmNXNHpaMnBRTkJZCjZYR01EdUNyUjB2Vk0vdGZDWFha
            TnpOaFJkYm55bGp3YVNJVi9jay95YU0KLS0tIDlycnQwRXlqdW5FVTJPajVVTDRI
            U2Ywc3Q0OHltSkRVSEpzUCsvTndNVEEKDVq/VEwjqDSGKzTwJGM+Q5S6v6jBlobL
            xsblFV4loNMlHXwv1PS6Wm0agY5kwGf09KbsNuNLfYjPSIsWxfGZHA==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age1p2rjyt2kpcuae99kprkqzw7ecuy84ag5y0cj60upzh4pnqqq94dqygaa8y
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBLQm1SQzdlbjlMQlF4Rjhx
            WEoxUm9UNjQ1UWNOOWF6VFZSVExTbFkwUW1zClRRVzN0NWI0dm0vSzlxNnhrRy9u
            RVo1ZkJyNitKOEVtQzRCME9MYVlFWVUKLS0tIHV4a2VPZmNDcHluSXJDR2xJWDF0
            TDN4Yi8vblJldUlhSXNQTXh5a0I4aWsKxshmecvNO0vHcfQDVniOzwacgqgTNHKU
            R9uxnzfwFYmxHPOPpwcO+reqWcuFkwTSSnG8l7MQuCPrcLzm4hncnQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2026-01-12T17:07:06Z"
    mac: ENC[AES256_GCM,data:Y5jLxrpKHzdCBJKiNuOEpBZSdCFPFyaHb4Qi+EdSlmd4soDtN44xQszOWRkDPsEzsSLqnLeaV3f42zHiwucLOIe/y6ZEjUbN/T57FG2wjR2WVXNOH1/0l/dSFlRSYJCk8NcnSxCQQ6btfXxPU4TL32VVkOPN98BvO02fXyQLRpg=,iv:0IU+oXqJ2INC6h53YKyK5FhktSGhM+4sQxqlBnLaI9Y=,tag:vQ7xmEKb3FDWcPr9Xxacrw==,type:str]
    unencrypted_suffix: _unencrypted
    version: 3.11.0


